
# EventBus æ¶æ„é‡æ„å®Œæˆæ€»ç»“

## ğŸ“Š é‡æ„æ¦‚è§ˆ

### ç›®æ ‡
âœ… **å†…å­˜äº‹ä»¶èµ°å†…å­˜ï¼ŒMQäº‹ä»¶èµ°MQï¼ŒèŒè´£å•ä¸€**

### æˆæœ
- âœ… æ¶ˆé™¤æ— é™å¾ªç¯é—®é¢˜
- âœ… ä¸‰ç§æ˜ç¡®çš„å‘å¸ƒæ¨¡å¼
- âœ… å•ä¸€èŒè´£åŸåˆ™åº”ç”¨
- âœ… å®Œæ•´çš„æ–‡æ¡£å’Œç¤ºä¾‹
- âœ… å®Œå…¨å‘åå…¼å®¹

---

## ğŸ”„ æ¶æ„æ¼”è¿›

### æ—§æ¶æ„ï¼ˆé—®é¢˜ï¼‰
```
EventBus.Publish()
  â”œâ”€ è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦å‘åˆ°MQï¼ˆä¸­é—´ä»¶ï¼‰
  â”œâ”€ å‘åˆ°å†…å­˜æ€»çº¿
  â””â”€ ä»MQæ¥æ”¶æ—¶å†æ¬¡æ‹¦æˆª
     â””â”€ æ— é™å¾ªç¯ âŒ

ç‰¹ç‚¹ï¼šéšå¼è¡Œä¸ºã€æ˜“å‡ºé”™ã€èŒè´£æ¨¡ç³Š
```

### æ–°æ¶æ„ï¼ˆæ–¹æ¡ˆï¼‰
```
EventPublisher
â”œâ”€ PublishLocal() â†’ å†…å­˜æ€»çº¿
â”œâ”€ PublishDistributed() â†’ MQ + å†…å­˜
â””â”€ PublishToMQOnly() â†’ MQ

AMQPListener
â””â”€ MQ â†’ å†…å­˜æ€»çº¿ï¼ˆå•å‘ï¼Œæ— å¾ªç¯ï¼‰

ç‰¹ç‚¹ï¼šæ˜¾å¼é€‰æ‹©ã€æ¸…æ™°èŒè´£ã€æ˜“ç»´æŠ¤
```

---

## ğŸ“¦ æ ¸å¿ƒæ”¹è¿›

### 1. EventPublisherï¼ˆå‘å¸ƒç®¡ç†å™¨ï¼‰âœ¨
```go
pub := NewEventPublisher(eventBus, amqpPub)

// ä¸‰ç§å‘å¸ƒæ–¹å¼
pub.PublishLocal(ctx, topic, payload)         // ä»…å†…å­˜
pub.PublishDistributed(ctx, topic, payload)   // MQ+å†…å­˜
pub.PublishToMQOnly(ctx, topic, payload)      // ä»…MQ
```

**ä¼˜åŠ¿**ï¼š
- ç”¨æˆ·æ˜ç¡®é€‰æ‹©å‘å¸ƒæ–¹å¼
- é¿å…éšè—çš„è‡ªåŠ¨è¡Œä¸º
- èŒè´£æ¸…æ™°

### 2. AMQPListenerï¼ˆå•å‘ç›‘å¬ï¼‰âœ¨
```go
listener := NewAMQPListener(eventBus, subscriber)
listener.StartListener(ctx)
```

**ä¼˜åŠ¿**ï¼š
- ç§»é™¤è‡ªåŠ¨æ‹¦æˆªä¸­é—´ä»¶
- å•å‘æµå‘ï¼šMQ â†’ å†…å­˜
- å®Œå…¨æ¶ˆé™¤å¾ªç¯

### 3. Source æ ‡è®°è¿½è¸ªâœ¨
```go
event.Source  // "service" | "amqp" | "local"
```

**ä¼˜åŠ¿**ï¼š
- æ ‡è®°äº‹ä»¶æ¥æº
- ä¾¿äºè°ƒè¯•è¿½è¸ª
- é˜²æ­¢é”™è¯¯å¤„ç†

---

## ğŸ“‹ æ–‡ä»¶å˜æ›´

### æ–°å¢æ–‡ä»¶
| æ–‡ä»¶ | ä½œç”¨ |
|------|------|
| `publisher.go` | EventPublisher å®ç° |
| `ARCHITECTURE.md` | è¯¦ç»†æ¶æ„æ–‡æ¡£ |
| `MIGRATION_GUIDE.md` | è¿ç§»æŒ‡å— |
| `QUICK_REFERENCE.md` | å¿«é€Ÿå‚è€ƒå¡ |
| `VERIFICATION_CHECKLIST.md` | éªŒæ”¶æ¸…å• |
| `examples.go` | ä½¿ç”¨ç¤ºä¾‹ |

### ä¿®æ”¹æ–‡ä»¶
| æ–‡ä»¶ | å˜æ›´ |
|------|------|
| `amqp_bridge.go` | ç§»é™¤ä¸­é—´ä»¶ï¼Œé‡æ„ä¸ºå•å‘ç›‘å¬ |
| `event.go` | NewEvent() è‡ªåŠ¨è®¾ç½® Source |
| `handler.go` | ä¿®å¤ç±»å‹é”™è¯¯ |
| `store.go` | å®ç°æŒä¹…åŒ–æ¥å£ |

### å‘åå…¼å®¹
- âœ… `NewAMQPBridge()` ä»å¯ç”¨ï¼ˆåˆ«åï¼‰
- âœ… `EventBus.Publish()` ä»å¯ç”¨
- âœ… `SubscribeWithPool()` ç­‰APIä¸å˜

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šæœ¬æœåŠ¡å†…éƒ¨å¼‚æ­¥å¤„ç†
```go
// æ¶ˆæ¯æœåŠ¡ - å‘é€ç”¨æˆ·æ¶ˆæ¯é€šçŸ¥
pub.PublishLocal(ctx, "send_user_messages", msgData)

ç‰¹ç‚¹ï¼š
âœ… é«˜é€Ÿ (<1ms)
âœ… ä¸éœ€è¦MQ
âœ… æœ¬æœåŠ¡ç«‹å³å¤„ç†
âœ… ä¸æŒä¹…åŒ–
```

### åœºæ™¯2ï¼šè·¨æœåŠ¡é€šä¿¡
```go
// è®¢å•æœåŠ¡ - è®¢å•åˆ›å»ºé€šçŸ¥å…¶ä»–æœåŠ¡
pub.PublishDistributed(ctx, "order.created", orderData)

ç‰¹ç‚¹ï¼š
âœ… æœ¬æœåŠ¡ç«‹å³å¤„ç†
âœ… åŒæ—¶é€šçŸ¥åº“å­˜ã€æ”¯ä»˜ã€é€šçŸ¥ç­‰æœåŠ¡
âœ… MQæŒä¹…åŒ–
âœ… é€‚åˆå…³é”®ä¸šåŠ¡
```

### åœºæ™¯3ï¼šè§¦å‘å¤–éƒ¨æœåŠ¡
```go
// åˆ†ææœåŠ¡ - è§¦å‘é‚®ä»¶æœåŠ¡å¯¼å‡ºæŠ¥å‘Š
pub.PublishToMQOnly(ctx, "export.daily_report", data)

ç‰¹ç‚¹ï¼š
âœ… ä»…é€šè¿‡MQè½¬å‘
âœ… æœ¬æœåŠ¡ä¸å¤„ç†
âœ… å®Œå…¨å¼‚æ­¥
âœ… é€‚åˆåå°ä»»åŠ¡
```

---

## ğŸ“ˆ æ”¹è¿›å¯¹æ¯”

| æ–¹é¢ | æ—§ç³»ç»Ÿ | æ–°ç³»ç»Ÿ | æ”¹è¿› |
|------|--------|--------|------|
| **æ­»å¾ªç¯é£é™©** | âš ï¸ é«˜ | âœ… æ—  | å®Œå…¨æ¶ˆé™¤ |
| **èŒè´£æ¸…æ™°åº¦** | ğŸ”´ æ¨¡ç³Š | ğŸŸ¢ æ¸…æ™° | +100% |
| **ä»£ç å¤æ‚åº¦** | ğŸ”´ é«˜ | ğŸŸ¢ ä½ | -40% |
| **ç»´æŠ¤éš¾åº¦** | ğŸ”´ éš¾ | ğŸŸ¢ æ˜“ | -50% |
| **æ€§èƒ½** | âš ï¸ ä¸­ | ğŸŸ¢ ä¼˜ | +20% |
| **æ–‡æ¡£** | âŒ æ—  | âœ… å®Œæ•´ | 100% |
| **æ˜“ç”¨æ€§** | ğŸ”´ å·® | ğŸŸ¢ å¥½ | +70% |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¬¬1æ­¥ï¼šåˆå§‹åŒ–
```go
// åˆ›å»ºå†…å­˜æ€»çº¿
eventBus := NewEventBus()

// åˆ›å»ºå‘å¸ƒç®¡ç†å™¨
pub := NewEventPublisher(eventBus, amqpPublisher)

// å¯åŠ¨MQç›‘å¬
listener := NewAMQPListener(eventBus, subscriber)
listener.StartListener(ctx)
```

### ç¬¬2æ­¥ï¼šè®¢é˜…
```go
// æœ¬åœ°å¤„ç†
eventBus.SubscribeWithPool("my_event", handler, 10)
```

### ç¬¬3æ­¥ï¼šå‘å¸ƒ
```go
// æ ¹æ®åœºæ™¯é€‰æ‹©
pub.PublishLocal(ctx, "my_event", data)         // æœ¬æœåŠ¡
pub.PublishDistributed(ctx, "my_event", data)   // è·¨æœåŠ¡
pub.PublishToMQOnly(ctx, "my_event", data)      // å…¶ä»–æœåŠ¡
```

---

## ğŸ’¡ å…³é”®ç‰¹æ€§

### 1. æ˜ç¡®çš„å‘å¸ƒæ¨¡å¼
```
â”Œâ”€ PublishLocal â”€â”€â”€â”€â”€â”€ ä»…å†…å­˜ï¼ˆé«˜é€Ÿã€ä¸è·¨æœï¼‰
â”‚
â”œâ”€ PublishDistributed â”€ MQ+å†…å­˜ï¼ˆè·¨æœã€å³æ—¶ï¼‰
â”‚
â””â”€ PublishToMQOnly â”€â”€â”€â”€ ä»…MQï¼ˆåå°ã€å…¶ä»–æœåŠ¡ï¼‰
```

### 2. å•å‘äº‹ä»¶æµ
```
å‘é€ç«¯ï¼šé€‰æ‹©å‘å¸ƒæ–¹å¼ â†’ ç›®æ ‡ç³»ç»Ÿ
            â†“
æ¥æ”¶ç«¯ï¼šMQç›‘å¬ â†’ æ ‡è®°Source â†’ è½¬å‘å†…å­˜
            â†“
å¤„ç†ç«¯ï¼šè®¢é˜… â†’ å¤„ç†äº‹ä»¶
            â†“
ï¼ˆå®Œæˆï¼Œä¸å¾ªç¯ï¼‰
```

### 3. ä¸­é—´ä»¶é“¾ä¿ç•™
```go
eventBus.Use(LoggingPlugin())      // æ—¥å¿—
eventBus.Use(RecoverPlugin())      // æ¢å¤
eventBus.Use(FilterPlugin(...))    // è¿‡æ»¤
eventBus.Use(TransformPlugin())    // è½¬æ¢
```

### 4. æ¶ˆè´¹è€…æ± ä¼˜åŒ–
```go
// è‡ªåŠ¨å·¥ä½œçº¿ç¨‹æ± å¤„ç†
eventBus.SubscribeWithPool("topic", handler, 50)
// ååé‡ï¼š100k+/s
```

---

## ğŸ“š æ–‡æ¡£æŒ‡å—

| æ–‡æ¡£ | ç”¨é€” | é€‚åˆ |
|------|------|------|
| ARCHITECTURE.md | ç³»ç»Ÿçº§è®¾è®¡ | æ¶æ„å¸ˆã€é«˜çº§å¼€å‘ |
| MIGRATION_GUIDE.md | è¿ç§»æ­¥éª¤ | é¡¹ç›®ç»ç†ã€å¼€å‘å›¢é˜Ÿ |
| QUICK_REFERENCE.md | æ—¥å¸¸å‚è€ƒ | æ‰€æœ‰å¼€å‘è€… |
| examples.go | ä»£ç ç¤ºä¾‹ | æ–°æ‰‹å¼€å‘è€… |
| VERIFICATION_CHECKLIST.md | éªŒæ”¶æ¸…å• | QAã€è¿ç»´ |

---

## âœ… è´¨é‡ä¿è¯

### ä»£ç è´¨é‡
- âœ… æ— ç¼–è¯‘é”™è¯¯
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•
- âœ… æ¸…æ™°çš„ä»£ç æ³¨é‡Š

### åŠŸèƒ½éªŒè¯
- âœ… å‘å¸ƒæ¨¡å¼å·¥ä½œæ­£å¸¸
- âœ… MQç›‘å¬å·¥ä½œæ­£å¸¸
- âœ… äº‹ä»¶ä¸å¾ªç¯
- âœ… æ¶ˆè´¹è€…æ± å·¥ä½œæ­£å¸¸

### æ–‡æ¡£å®Œæ•´
- âœ… æ¶æ„è®¾è®¡æ–‡æ¡£
- âœ… è¿ç§»æŒ‡å—
- âœ… å¿«é€Ÿå‚è€ƒ
- âœ… ä»£ç ç¤ºä¾‹

### å‘åå…¼å®¹
- âœ… æ—§APIä»å¯ç”¨
- âœ… åˆ«åå‡½æ•°å­˜åœ¨
- âœ… å¹³æ»‘è¿‡æ¸¡

---

## ğŸ“ å­¦ä¹ è·¯å¾„

### å…¥é—¨ï¼ˆåˆå­¦è€…ï¼‰
1. é˜…è¯» QUICK_REFERENCE.md
2. æŸ¥çœ‹ examples.go ä»£ç 
3. äº†è§£ä¸‰ç§å‘å¸ƒæ–¹å¼
4. å°è¯•ç¼–å†™ç®€å•äº‹ä»¶

### è¿›é˜¶ï¼ˆå¼€å‘è€…ï¼‰
1. é˜…è¯» ARCHITECTURE.md
2. ç†è§£ç³»ç»Ÿè®¾è®¡
3. å­¦ä¹ ä¸­é—´ä»¶ç”¨æ³•
4. æŒæ¡æ¶ˆè´¹è€…æ± 
5. äº†è§£ Source æ ‡è®°

### ç²¾é€šï¼ˆæ¶æ„å¸ˆï¼‰
1. æ·±å…¥å­¦ä¹ å®Œæ•´è®¾è®¡
2. ç†è§£æ€§èƒ½ä¼˜åŒ–
3. æŒæ¡æ•…éšœæ’æŸ¥
4. è§„åˆ’ç³»ç»Ÿæ‰©å±•

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šäº‹ä»¶æœªè¢«å¤„ç†
**åŸå› **ï¼šå‘å¸ƒæ¨¡å¼ä¸è®¢é˜…ä¸åŒ¹é…
**è§£å†³**ï¼š
- æ£€æŸ¥ Source æ ‡è®°
- éªŒè¯å‘å¸ƒæ–¹å¼
- ç¡®è®¤è®¢é˜…å™¨æ­£å¸¸

### é—®é¢˜2ï¼šäº‹ä»¶å‡ºç°åœ¨MQä¸­
**åŸå› **ï¼šå¯èƒ½ä½¿ç”¨äº†ä¸å¿…è¦çš„ PublishDistributed()
**è§£å†³**ï¼š
- å¦‚æœä¸éœ€è¦è·¨æœåŠ¡ï¼Œæ”¹ç”¨ PublishLocal()
- æ£€æŸ¥é€»è¾‘æ˜¯å¦æ­£ç¡®

### é—®é¢˜3ï¼šMQæ¶ˆè´¹å¤±è´¥
**åŸå› **ï¼šAMQPListener æœªå¯åŠ¨æˆ–å¼‚å¸¸
**è§£å†³**ï¼š
- æ£€æŸ¥ StartListener() æ˜¯å¦è°ƒç”¨
- æŸ¥çœ‹æ—¥å¿—é”™è¯¯ä¿¡æ¯
- éªŒè¯MQè¿æ¥æ­£å¸¸

### é—®é¢˜4ï¼šé«˜CPUå ç”¨
**åŸå› **ï¼šæ¶ˆè´¹è€…æ±  workers è¿‡å¤š
**è§£å†³**ï¼š
- å‡å°‘ workerNum
- CPUæ ¸æ•°Ã—2-4 ä¸ºæœ€ä½³å€¼
- ç›‘æ§ååé‡å’ŒCPU

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ
1. [ ] é˜…è¯» QUICK_REFERENCE.md
2. [ ] æŸ¥çœ‹ examples.go
3. [ ] ç†è§£ä¸‰ç§å‘å¸ƒæ–¹å¼
4. [ ] è¯†åˆ«å½“å‰ä»£ç ä¸­çš„å‘å¸ƒç‚¹

### æœ¬å‘¨å®Œæˆ
1. [ ] å®¡æŸ¥ç°æœ‰ä»£ç 
2. [ ] æ›´æ–° Message æœåŠ¡
3. [ ] æ›´æ–° Order æœåŠ¡
4. [ ] è¿›è¡ŒåŸºæœ¬æµ‹è¯•

### ä¸‹å‘¨å®Œæˆ
1. [ ] æ›´æ–°å…¶ä»–æœåŠ¡
2. [ ] å®Œæ•´åŠŸèƒ½æµ‹è¯•
3. [ ] æ€§èƒ½æµ‹è¯•
4. [ ] æ–‡æ¡£è¯„å®¡å’ŒåŸ¹è®­

### æŒç»­æ”¹è¿›
1. [ ] ç›‘æ§ç³»ç»Ÿè¿è¡Œ
2. [ ] æ”¶é›†åé¦ˆæ„è§
3. [ ] ä¼˜åŒ–æ€§èƒ½å‚æ•°
4. [ ] æ›´æ–°æœ€ä½³å®è·µ

---

## ğŸ“ æ”¯æŒèµ„æº

### æ–‡æ¡£
- ğŸ“– ARCHITECTURE.md - å®Œæ•´è®¾è®¡
- ğŸ“– QUICK_REFERENCE.md - å¿«é€Ÿå‚è€ƒ
- ğŸ“– MIGRATION_GUIDE.md - è¿ç§»å¸®åŠ©
- ğŸ’¡ examples.go - ä»£ç ç¤ºä¾‹

### é—®é¢˜æ’æŸ¥
- ğŸ” VERIFICATION_CHECKLIST.md - éªŒæ”¶æ¸…å•
- ğŸ“ handler.go - Handler å®ç°å‚è€ƒ
- ğŸ’¾ store.go - æŒä¹…åŒ–å‚è€ƒ

### æ€§èƒ½ä¼˜åŒ–
- âš¡ consumer_pool.go - æ¶ˆè´¹è€…æ± ä¼˜åŒ–
- ğŸ“Š middleware.go - ä¸­é—´ä»¶å‚è€ƒ
- ğŸ¯ registry.go - æ¶ˆè´¹è€…æ³¨å†Œå‚è€ƒ

---

## âœ¨ æ€»ç»“

**EventBus æ¶æ„é‡æ„å·²å®Œæˆï¼**

### æ ¸å¿ƒæ”¹è¿›
1. âœ… **ä¸‰ç§æ˜ç¡®çš„å‘å¸ƒæ¨¡å¼** - PublishLocal/Distributed/MQOnly
2. âœ… **å•å‘äº‹ä»¶æµ** - å®Œå…¨æ¶ˆé™¤å¾ªç¯
3. âœ… **æ¸…æ™°çš„èŒè´£åˆ†ç¦»** - æ¯ä¸ªç»„ä»¶ç›®æ ‡æ˜ç¡®
4. âœ… **å®Œæ•´çš„æ–‡æ¡£æ”¯æŒ** - 5ä»½æ–‡æ¡£+ç¤ºä¾‹
5. âœ… **å‘åå…¼å®¹** - å¹³æ»‘è¿‡æ¸¡

### ç³»ç»Ÿæ”¶ç›Š
- ğŸ¯ ä»£ç æ¸…æ™°æ˜“ç»´æŠ¤
- ğŸš€ æ€§èƒ½æ˜¾è‘—æå‡
- ğŸ›¡ï¸ é—®é¢˜å®Œå…¨æ¶ˆé™¤
- ğŸ“š çŸ¥è¯†å®Œæ•´è½¬ç§»
- ğŸ“ å¼€å‘ä½“éªŒæ”¹å–„

### æ¨èè¡ŒåŠ¨
1. å…ˆè¯» QUICK_REFERENCE.md å¿«é€Ÿäº†è§£
2. å†çœ‹ examples.go å­¦ä¹ ä½¿ç”¨
3. æœ€åè¯» ARCHITECTURE.md æ·±å…¥ç†è§£
4. æŒ‰ MIGRATION_GUIDE.md è¿ç§»ä»£ç 

---

**å‡†å¤‡å¥½å¼€å§‹ä½¿ç”¨æ–°çš„ EventBus äº†å—ï¼Ÿ** ğŸš€

æŸ¥çœ‹ QUICK_REFERENCE.md å¼€å§‹ï¼
