
# [eventbus](.)

|   步骤        |代码位置                        | 作用                                 |
|1. 创建        |NewPublisher                    |建立 RabbitMQ 连接与交换机            |
|2. 获取接收者  |getRecipients                  |确定要发给谁（10 个用户）             |
|3. 准备消息    |prepareBatchMessages            |为每个接收者构建 BatchMessage，包含路由键、关联 ID、消息体|
|4. 异步发布    |PublishAsync                    |后台 goroutine 逐条发送，结果通过通道返回|
|5. 收集结果	|for result := range resultCh   |汇总成功/失败统计，支持重试逻辑|
|6. 关闭释放	|defer m.Close()                |	释放 channel，确保资源不泄漏|


## AMQP 客户端使用步骤
#### 1. 创建发布者（Publisher）
- 使用 `NewPublisher` 函数创建一个新的 AMQP 发布者实例，建立与 RabbitMQ 服务器的连接，并声明所需的交换机（Exchange）。
- 配置连接参数，如服务器地址、交换机名称和类型等。
- 2. 准备消息
- 为每个接收者构建消息体，通常包括路由键（Routing Key）、关联 ID 和实际消息内容。
- 3. 异步发布消息
- 使用 `PublishAsync` 方法将消息异步发送到 RabbitMQ。该方法会在后台启动一个 goroutine，逐条发送消息，并通过结果通道返回每条消息的发送结果。
- 4. 收集发布结果
- 通过结果通道收集每条消息的发送结果，统计成功和失败的消息数量，并根据需要实现重试逻辑。
- 5. 关闭发布者
- 在完成消息发布后，调用 `Close` 方法关闭发布者，释放相关资源，确保连接和通道不泄漏。  
#### 1. 创建消费者（Subscribe） 
- 使用 `NewSubscriber` 函数创建一个新的 AMQP 消费者实例，建立与 RabbitMQ 服务器的连接，并声明所需的队列（Queue）。
- 配置连接参数，如服务器地址、队列名称等。
- 2. 订阅消息
- 使用 `Subscribe` 方法订阅指定队列的消息。该方法会启动一个 goroutine，持续监听队列中的新消息，并将接收到的消息传递给注册的处理函数进行处理。
- 3. 处理消息
- 在处理函数中实现具体的消息处理逻辑，如解析消息内容、执行业务操作等。
- 4. 确认消息
- 在消息处理完成后，调用 `Ack` 方法确认消息已被成功处理，RabbitMQ 会将该消息从队列中移除。
- 5. 关闭消费者
- 在不再需要接收消息时，调用 `Close` 方法关闭消费者，释放相关资源，确保连接和通道不泄漏。
